package me.jadc.jadbreaks.addons;

import org.bukkit.ChatColor;
import org.bukkit.Material;
import org.bukkit.block.Block;
import org.bukkit.entity.Entity;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.EntityShootBowEvent;
import org.bukkit.event.entity.ProjectileHitEvent;
import org.bukkit.inventory.ItemStack;

import me.jadc.jadbreaks.objects.CustomArrow;
import me.jadc.jadbreaks.tools.Message;

public class CustomArrowHandler implements Listener {
	
	public static CustomArrow arrowTNT = new CustomArrow("Arrow with TNT", Material.TNT);
	
	public boolean isArrow(ItemStack s) {
		if (s.getType().equals(Material.ARROW)) return true;
		if (s.getType().equals(Material.TIPPED_ARROW)) return true;
		if (s.getType().equals(Material.SPECTRAL_ARROW)) return true;
		return false;
	}

	public ItemStack getArrowItem(Player p) {
		// Check offhand first
		if (p.getInventory().getItemInOffHand() != null && isArrow(p.getInventory().getItemInOffHand())) {
			return p.getInventory().getItemInOffHand();
		} else {
			// Check inventory in order
			for (ItemStack stack : p.getInventory().getContents()) {
				if (stack != null && isArrow(stack)) {
					return stack;
				}
			}
		}
		return null;
	}

	// Name arrow entity if itemstack has name
	@EventHandler
	public void onShoot(EntityShootBowEvent e) {
		if (!(e.getEntity() instanceof Player))
			return;
		Player p = (Player) e.getEntity();
		ItemStack arrow = getArrowItem(p);
		if (arrow.getType().equals(Material.ARROW)) {
			if (arrow.hasItemMeta()) {
				if (arrow.getItemMeta().hasDisplayName()) {
					Message.d("b4: " + arrow.getItemMeta().getDisplayName());
					if(arrow.getItemMeta().getDisplayName().startsWith(ChatColor.RESET + "")) {
						Message.log("proj set: " + ChatColor.stripColor(arrow.getItemMeta().getDisplayName()));
						e.getProjectile().setCustomName(ChatColor.stripColor(arrow.getItemMeta().getDisplayName()));
						// temp
						e.getProjectile().setCustomNameVisible(true);
					}
				}
			}
		}
	}
	
	// ARROW BEHAVIOUR DEFINITIONS
	@EventHandler
	public void onArrowLand(ProjectileHitEvent e) {
		// If custom
		if(e.getEntity().getCustomName() == null) return;
		//if(!e.getEntity().getCustomName().startsWith(ChatColor.RESET + "")) return;
		
		String name = e.getEntity().getCustomName();
		Message.log("name: " + name);
		Message.log("var: " + arrowTNT.getName());
		Message.log((name == arrowTNT.getName() ? "yes" : "no"));
		
		// If arrow landed on block
		if(e.getHitBlock() != null) {
			Block b = e.getHitBlock();
			//
			if(name == arrowTNT.getName()) b.getWorld().createExplosion(b.getLocation(), 1);
			//
		}
		
		// If hit entity
		if(e.getHitEntity() != null) {
			Entity en = e.getHitEntity();
			//
			if(name == arrowTNT.getName()) en.getWorld().createExplosion(en.getLocation(), 4);
			//
		}
		
		// Kill arrow
		e.getEntity().remove();
	}
}
